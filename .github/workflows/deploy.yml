name: ðŸš€ Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch: # Manual trigger dari GitHub UI

# ============================================
# GITHUB SECRETS YANG HARUS DI-SET:
# ============================================
# FTP_SERVER          â†’ hostname FTP (misal: ftp.grapadikonsultan.co.id)
# FTP_USERNAME        â†’ username FTP
# FTP_PASSWORD        â†’ password FTP
#
# BACKEND ENV:
# APP_KEY             â†’ Laravel app key (base64:xxx...)
# DB_HOST             â†’ Database host
# DB_DATABASE         â†’ Database name
# DB_USERNAME         â†’ Database username
# DB_PASSWORD         â†’ Database password
# ============================================
#
# STRUKTUR FTP (1 akun, akses ke semua folder):
# ============================================
# /
# â”œâ”€â”€ api.strategix.grapadikonsultan.co.id/
# â”‚   â”œâ”€â”€ app/, config/, vendor/, .env, ...  â† Laravel core
# â”‚   â””â”€â”€ public_html/                       â† Document root API
# â”‚       â”œâ”€â”€ index.php
# â”‚       â””â”€â”€ .htaccess
# â””â”€â”€ strategix.grapadikonsultan.co.id/
#     â””â”€â”€ public_html/                       â† Document root Frontend
#         â”œâ”€â”€ index.html
#         â”œâ”€â”€ .htaccess
#         â””â”€â”€ assets/
# ============================================

jobs:
  # ==========================================
  # JOB 1: Deploy Backend (Laravel API)
  # ==========================================
  deploy-backend:
    name: ðŸ”§ Deploy Backend API
    runs-on: ubuntu-latest
    environment: Konfigurasi FTP

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ˜ Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, bcmath, gd, pdo_mysql
          coverage: none

      - name: ðŸ“¦ Install Composer dependencies
        working-directory: backend
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      - name: ðŸ“ Create .env production
        working-directory: backend
        run: |
          cat > .env << 'ENVFILE'
          APP_NAME="Grapadi Strategix"
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_TIMEZONE=Asia/Jakarta
          APP_URL=https://api.strategix.grapadikonsultan.co.id

          FRONTEND_URL=https://strategix.grapadikonsultan.co.id

          APP_LOCALE=en
          APP_FALLBACK_LOCALE=en
          APP_FAKER_LOCALE=en_US
          APP_MAINTENANCE_DRIVER=file

          BCRYPT_ROUNDS=12

          LOG_CHANNEL=stack
          LOG_STACK=single
          LOG_DEPRECATIONS_CHANNEL=null
          LOG_LEVEL=error

          DB_CONNECTION=mysql
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=3306
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          SESSION_DRIVER=file
          SESSION_LIFETIME=120
          SESSION_ENCRYPT=false
          SESSION_PATH=/
          SESSION_DOMAIN=.strategix.grapadikonsultan.co.id

          BROADCAST_CONNECTION=log
          FILESYSTEM_DISK=public
          QUEUE_CONNECTION=database

          CACHE_STORE=file
          CACHE_PREFIX=

          SANCTUM_STATEFUL_DOMAINS=strategix.grapadikonsultan.co.id,www.strategix.grapadikonsultan.co.id

          MAIL_MAILER=log

          VITE_APP_NAME="Grapadi Strategix"
          ENVFILE

      # -------------------------------------------
      # STEP 1: Upload Laravel core ke folder subdomain API
      # -------------------------------------------
      - name: ðŸš€ Deploy Laravel core â†’ /api.strategix.../
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./backend/
          server-dir: api.strategix.grapadikonsultan.co.id/
          state-name: .ftp-deploy-backend-core.json
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/tests/**
            **/public/**
            **/storage/logs/**
            **/storage/framework/cache/**
            **/storage/framework/sessions/**
            **/storage/framework/views/**
            **/.env.example
            **/.env.singapay.example
            **/phpunit.xml
            **/vite.config.js
            **/tailwind.config.js
            **/postcss.config.js
            **/package.json
            **/package-lock.json
            **/debug_singapay.php
            **/test-packages-api.php
            **/test_qris_logic.php
            **/verify_transactions.php
            **/vendor.zip
            **/planweb

      # -------------------------------------------
      # STEP 2: Upload public/ ke public_html/
      # -------------------------------------------
      - name: ðŸš€ Deploy public/ â†’ /api.strategix.../public_html/
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./backend/public/
          server-dir: api.strategix.grapadikonsultan.co.id/public_html/
          state-name: .ftp-deploy-backend-public.json
          dangerous-clean-slate: false

  # ==========================================
  # JOB 2: Deploy Frontend (React)
  # ==========================================
  deploy-frontend:
    name: ðŸŽ¨ Deploy Frontend
    runs-on: ubuntu-latest
    environment: Konfigurasi FTP

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: frontend
        run: npm ci

      - name: ðŸ—ï¸ Build production
        working-directory: frontend
        run: npm run build
        env:
          VITE_API_URL: https://api.strategix.grapadikonsultan.co.id
          VITE_APP_URL: https://strategix.grapadikonsultan.co.id
          VITE_APP_NAME: "Grapadi Strategix"
          VITE_APP_VERSION: "1.3"
          VITE_ENABLE_ANALYTICS: "false"
          VITE_ENABLE_DEBUG: "false"

      - name: ðŸ“‹ Copy .htaccess to dist
        run: cp frontend/.htaccess frontend/dist/.htaccess

      - name: ðŸš€ Deploy Frontend â†’ /strategix.../public_html/
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./frontend/dist/
          server-dir: strategix.grapadikonsultan.co.id/public_html/
          dangerous-clean-slate: false
